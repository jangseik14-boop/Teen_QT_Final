<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>예본TeenQT</title>
    
    <!-- PWA 설정 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="예본TeenQT">
    <meta name="theme-color" content="#8B5CF6">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3076/3076416.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3076/3076416.png">
    
    <!-- 필수 라이브러리 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        
        /* 모바일 전체화면 및 안전 영역 설정 */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
            overscroll-behavior: none; /* 스크롤 바운스 방지 */
        }
        
        /* 아이폰 노치 및 하단 바 대응 */
        .pt-safe { padding-top: max(1.5rem, env(safe-area-inset-top)); }
        .pb-safe { padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
        
        /* 동적 뷰포트 높이 (주소창 대응) */
        .h-dvh { height: 100vh; height: 100dvh; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root" class="w-full h-full"></div>

    <script type="text/babel">
        // [설정] 파이어베이스 설정값 (자동 적용)
        const firebaseConfig = {
            apiKey: "AIzaSyCPzzgqHSUiCw7Mm2VR1OBK91UTJ0leKus",
            authDomain: "yebon-teen-qt.firebaseapp.com",
            projectId: "yebon-teen-qt",
            storageBucket: "yebon-teen-qt.firebasestorage.app",
            messagingSenderId: "804685061395",
            appId: "1:804685061395:web:5d7c386a5ebba4ee8c4ee6",
            measurementId: "G-ZLDY49Q3V3"
        };

        // Firebase 초기화 (안전장치 포함)
        let isFirebaseInitialized = false;
        let auth, db;
        const appId = 'yebon_teen_qt';

        try {
            if (!firebase.apps.length) {
                if (firebaseConfig.apiKey !== "여기에_API_KEY를_붙여넣으세요") {
                    firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    isFirebaseInitialized = true;
                }
            } else {
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseInitialized = true;
            }
        } catch (error) {
            console.error("Firebase Init Error:", error);
        }

        const { useState, useEffect } = React;

        // --- 전역 헬퍼 함수 ---
        const getTodayString = () => {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        const getRecentSundayStr = () => {
            const d = new Date();
            d.setDate(d.getDate() - d.getDay()); // 일요일(0)을 기준으로 날짜 빼기
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        // --- 아이콘 ---
        const Icons = {
            BookOpen: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            ShoppingBag: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>,
            User: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Star: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            ChevronRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m9 18 6-6-6-6"/></svg>,
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Coffee: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></svg>,
            Sparkles: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            Gift: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></svg>,
            Lock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            Ticket: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></svg>,
            PartyPopper: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5.8 11.3 2 22l10.7-3.79"/><path d="M4 3h.01"/><path d="M22 8h.01"/><path d="M15 2h.01"/><path d="M22 20h.01"/><path d="m22 2-2.24.75a2.9 2.9 0 0 0-1.96 3.12v0c.1.86-.57 1.63-1.45 1.63h-.38c-.86 0-1.6.6-1.76 1.44L14 10"/><path d="m22 13-.82-.33c-.86-.34-1.82.2-1.98 1.11v0c-.11.7-.72 1.22-1.43 1.22H17"/><path d="m11 2 .33.82c.34.86-.2 1.82-1.11 1.98v0C9.52 4.9 9 5.52 9 6.23V7"/><path d="M11 13c1.93 1.93 2.83 4.17 2 5-.83.83-3.07-.07-5-2-1.93-1.93-2.83-4.17-2-5 .83-.83 3.07.07 5 2Z"/></svg>,
            HelpCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>,
            ChevronDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m6 9 6 6 6-6"/></svg>,
            ChevronUp: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m18 15-6-6-6 6"/></svg>,
            LogOut: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Loader: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
            Trophy: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            Camera: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
        };

        // --- 전역 데이터 (반드시 여기에 위치) ---
        
        // 아이콘 렌더링 도우미 함수
        const renderIcon = (iconName, colorClass, sizeClass = "w-6 h-6") => {
            const IconComponent = Icons[iconName] || Icons.Ticket;
            return <IconComponent className={`${sizeClass} ${colorClass}`} />;
        };

        const shopItems = [
            { id: 1, name: "올리브영 5,000원권", cost: 500, iconName: "Sparkles", iconColor: "text-green-500", category: "뷰티" },
            { id: 2, name: "편의점 5,000원권", cost: 500, iconName: "Gift", iconColor: "text-purple-500", category: "편의점" },
            { id: 3, name: "카페 5,000원권", cost: 500, iconName: "Coffee", iconColor: "text-yellow-600", category: "카페" },
            { id: 4, name: "배달의민족 5,000원권", cost: 500, iconName: "Ticket", iconColor: "text-teal-500", category: "배달" },
            { id: 5, name: "맘스터치 5,000원권", cost: 500, iconName: "Ticket", iconColor: "text-orange-500", category: "푸드" },
            { id: 6, name: "다이소 5,000원권", cost: 500, iconName: "ShoppingBag", iconColor: "text-rose-500", category: "쇼핑" },
            { id: 7, name: "에어팟4 노이즈 캔슬링", cost: 20000, iconName: "Star", iconColor: "text-slate-700", category: "특별상품" },
            { id: 8, name: "레노버 태블릿", cost: 20000, iconName: "BookOpen", iconColor: "text-blue-500", category: "스마트기기" },
        ];

        const qtDatabase = [
            { id: 1, title: "든든한 나의 목자", passage: "시편 23:1", scripture: "여호와는 나의 목자시니 내게 부족함이 없으리로다", commentary: "양은 시력이 약해서 스스로 길을 찾거나 맹수를 피할 수 없습니다. 오직 선한 목자만 곁에 있다면 가장 안전합니다. 내 인생의 목자 되시는 하나님이 내 삶을 책임지고 이끄실 때, 우리는 어떤 상황에서도 진짜 만족을 누릴 수 있습니다.", questions: ["내 삶에서 가장 부족하다고 느끼며 쫓고 있는 것은 무엇인가요?", "선한 목자이신 하나님을 온전히 믿고 내 인생의 운전대를 맡기기로 결단해 보세요."] },
            { id: 2, title: "두려워하지 말라", passage: "이사야 41:10", scripture: "두려워하지 말라 내가 너와 함께 함이라 놀라지 말라 나는 네 하나님이 됨이라", commentary: "새로운 학기, 성적에 대한 압박, 친구 문제로 앞이 캄캄하고 두려울 때가 있습니다. 하지만 온 우주를 다스리시는 하나님이 '내가 너와 함께하겠다'고 직접 약속하셨습니다. 내 옆에서 단단히 손을 잡고 계시는 하나님을 기억하세요.", questions: ["지금 나를 가장 두렵게 하거나 불안하게 만드는 일은 무엇인가요?", "언제나 나와 동행하시는 하나님을 기억하며 오늘 하루 담대하게 나아가세요."] },
            { id: 3, title: "내 짐을 대신 지시는 분", passage: "마태복음 11:28", scripture: "수고하고 무거운 짐 진 자들아 다 내게로 오라 내가 너희를 쉬게 하리라", commentary: "학업과 인간관계 등 무거운 짐을 혼자 해결하려다 보면 금방 지쳐 쓰러집니다. 예수님은 우리의 지친 모습 그대로를 환영하시며, 가장 따뜻한 품으로 안아주셔서 우리 영혼에 진정한 쉼(안식)을 허락하십니다.", questions: ["내가 혼자 끙끙 앓으며 짊어지고 있는 마음의 짐은 무엇인가요?", "예수님께 내 모든 무거운 짐을 툭 내려놓고 평안을 달라고 기도해 보세요."] },
            { id: 4, title: "염려 대신 감사 기도", passage: "빌립보서 4:6-7", scripture: "아무 것도 염려하지 말고 다만 모든 일에 기도와 간구로 너희 구할 것을 감사함으로 하나님께 아뢰라", commentary: "걱정은 내 힘으로 어찌할 수 없는 일들을 꽉 붙잡고 있을 때 생겨납니다. 그 문제들을 감사의 기도로 하나님께 넘겨드릴 때, 내 마음을 짓누르던 염려가 사라지고 놀라운 평안이 찾아올 것입니다.", questions: ["요즘 내 머릿속을 맴도는 쓸데없는 걱정거리들은 무엇인가요?", "그 걱정을 기도로 바꾼다면?"] },
            { id: 5, title: "세상이 줄 수 없는 평안", passage: "요한복음 14:27", scripture: "평안을 너희에게 끼치노니 곧 나의 평안을 너희에게 주노라", commentary: "세상이 주는 쾌락이나 재미는 잠시뿐이고 금세 더 큰 공허함을 가져다줍니다. 그러나 예수님이 우리 마음속 깊은 곳에 주시는 평화는, 내 주변 상황이 흔들려도 절대 빼앗기지 않는 진짜 든든한 평안입니다.", questions: ["유튜브나 게임 등 세상적인 방법으로 일시적인 위안을 얻으려 했던 적이 있나요?", "예수님이 주시는 진짜 평안으로 내 마음을 가득 채워달라고 구해보세요."] },
        ];

        const quizDatabase = [
            { id: 1, question: "천지창조 첫째 날, 하나님께서 가장 먼저 만드신 것은 무엇인가요?", options: ["빛", "바다", "동물", "사람"], answer: 0, explanation: "창세기 1장 3절, 하나님께서 '빛이 있으라' 하시니 빛이 생겼습니다!" },
            { id: 2, question: "노아의 방주에 탄 사람은 노아의 가족을 포함해 총 몇 명이었나요?", options: ["4명", "6명", "8명", "10명"], answer: 2, explanation: "베드로전서 3장 20절, 노아 부부와 세 아들 부부까지 총 8명입니다." },
            { id: 3, question: "아브라함이 100세에 기적적으로 낳은 약속의 아들 이름은?", options: ["이삭", "이스마엘", "야곱", "에서"], answer: 0, explanation: "창세기 21장, 하나님이 약속하신 대로 100세에 '이삭'을 낳았어요." },
            { id: 4, question: "모세가 홍해를 가를 때 손에 들고 사용한 것은 무엇인가요?", options: ["지팡이", "칼", "돌", "겉옷"], answer: 0, explanation: "출애굽기 14장 16절, 모세가 지팡이를 들고 손을 바다 위로 내밀어 바다가 갈라졌습니다." },
            { id: 5, question: "구약의 소년 다윗이 거인 골리앗을 쓰러뜨릴 때 사용한 무기는?", options: ["물매와 돌", "창", "방패", "활"], answer: 0, explanation: "사무엘상 17장, 다윗은 만군의 여호와의 이름과 물매돌 하나로 골리앗을 이겼습니다." },
        ];

        // AdminModal 컴포넌트
        const AdminModal = ({ onClose, appId, db, showToast }) => {
            const [activeTab, setActiveTab] = useState('qt'); // 'qt', 'users', 'requests'
            const [allHistory, setAllHistory] = useState([]);
            const [allUsers, setAllUsers] = useState([]);
            const [allRequests, setAllRequests] = useState([]); // 상품 신청 내역
            
            const [isLoadingUsers, setIsLoadingUsers] = useState(true);
            const [isLoadingQt, setIsLoadingQt] = useState(true);
            const [isLoadingRequests, setIsLoadingRequests] = useState(true);
            
            const [openFolders, setOpenFolders] = useState({}); // QT 기록 폴더 (이름별)
            const [openQtGroups, setOpenQtGroups] = useState({}); // QT 기록 폴더 (그룹별)
            const [openGroups, setOpenGroups] = useState({}); // 그룹별 회원 폴더
            const [openUserDetail, setOpenUserDetail] = useState({}); // 개별 회원 상세 정보
            const [adminAction, setAdminAction] = useState(null); // 모달 상태 (달란트 수정, 회원 삭제, 묵상 삭제, 상품신청 삭제)
            
            const [bulkInput, setBulkInput] = useState(''); // 일괄 업로드 입력값 상태

            useEffect(() => {
                if (!isFirebaseInitialized || !db) return;
                
                // 1. 회원 정보 불러오기
                const unsubscribeUsers = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        setAllUsers(snapshot.docs.map(doc => doc.data()));
                        setIsLoadingUsers(false);
                    }, (error) => {
                        console.error("Users Load Error:", error);
                        setIsLoadingUsers(false);
                    });

                // 2. 전체 QT 기록 불러오기
                const unsubscribeQt = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('all_qt_records')
                    .orderBy('timestamp', 'desc')
                    .onSnapshot((snapshot) => {
                        setAllHistory(snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })));
                        setIsLoadingQt(false);
                    }, (error) => {
                        console.error("QT Load Error:", error);
                        setIsLoadingQt(false);
                    });

                // 3. 상품 신청 내역 불러오기
                const unsubscribeRequests = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('item_requests')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        setAllRequests(snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })));
                        setIsLoadingRequests(false);
                    }, (error) => {
                        console.error("Requests Load Error:", error);
                        setIsLoadingRequests(false);
                    });

                return () => {
                    unsubscribeUsers();
                    unsubscribeQt();
                    unsubscribeRequests();
                };
            }, []);

            // 그룹(학년+성별) 판별 함수
            const getGroup = (user) => {
                const grade = user.grade || '';
                const gender = user.gender || '';
                
                if (grade.startsWith('중')) {
                    if (gender === '남성') return '중학생 남자';
                    if (gender === '여성') return '중학생 여자';
                } else if (grade.startsWith('고')) {
                    if (gender === '남성') return '고등학생 남자';
                    if (gender === '여성') return '고등학생 여자';
                }
                return '기타';
            };

            // 묵상 기록을 그룹 -> 이름 기준으로 2단계 그룹화
            const groupedQt = allHistory.reduce((acc, curr) => {
                const user = allUsers.find(u => u.id === curr.userId) || {};
                const groupName = getGroup(user);
                
                if (!acc[groupName]) acc[groupName] = {};
                if (!acc[groupName][curr.name]) acc[groupName][curr.name] = [];
                acc[groupName][curr.name].push(curr);
                return acc;
            }, {});

            // 그룹(학년+성별) 기준 회원 그룹화
            const groupedUsers = allUsers.reduce((acc, curr) => {
                const groupName = getGroup(curr);
                (acc[groupName] = acc[groupName] || []).push(curr);
                return acc;
            }, {});

            // 정렬용 그룹 순서
            const groupOrder = ["중학생 남자", "중학생 여자", "고등학생 남자", "고등학생 여자", "기타"];
            const sortedGroups = Object.keys(groupedUsers).sort((a, b) => {
                let idxA = groupOrder.indexOf(a);
                let idxB = groupOrder.indexOf(b);
                if(idxA === -1) idxA = 999;
                if(idxB === -1) idxB = 999;
                return idxA - idxB;
            });

            const sortedQtGroups = Object.keys(groupedQt).sort((a, b) => {
                let idxA = groupOrder.indexOf(a);
                let idxB = groupOrder.indexOf(b);
                if(idxA === -1) idxA = 999;
                if(idxB === -1) idxB = 999;
                return idxA - idxB;
            });

            const toggleFolder = (name) => setOpenFolders(prev => ({ ...prev, [name]: !prev[name] }));
            const toggleQtGroup = (group) => setOpenQtGroups(prev => ({ ...prev, [group]: !prev[group] }));
            const toggleGroup = (group) => setOpenGroups(prev => ({ ...prev, [group]: !prev[group] }));
            const toggleUserDetail = (userId) => setOpenUserDetail(prev => ({ ...prev, [userId]: !prev[userId] }));

            // 달란트 수정 핸들러 (누적 달란트도 함께 수정)
            const handleUpdateTalent = async () => {
                const { user, tempTalent } = adminAction;
                try {
                    const diff = Number(tempTalent) - (user.talents || 0);
                    const currentTotal = user.totalTalents !== undefined ? user.totalTalents : (user.talents || 0);
                    
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users').doc(user.id).set({ 
                        talents: Number(tempTalent),
                        totalTalents: currentTotal + diff
                    }, { merge: true });
                    setAdminAction(null);
                } catch (error) {
                    console.error("Talent Update Error:", error);
                }
            };

            // 회원 삭제 핸들러
            const handleDeleteUser = async () => {
                const { user } = adminAction;
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users').doc(user.id).delete();
                    setAdminAction(null);
                } catch (error) {
                    console.error("User Delete Error:", error);
                }
            };

            // 묵상 삭제 핸들러 (달란트 회수 포함 - 주일이면 60 회수, 평일이면 50 회수)
            const handleDeleteQt = async () => {
                const { record } = adminAction;
                try {
                    // 1. 전체 묵상 기록에서 삭제
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('all_qt_records').doc(record.id).delete();

                    // 2. 해당 유저의 개인 묵상 기록에서 삭제 (timestamp 일치하는 문서 찾기)
                    const qtUserDocs = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`qt_${record.userId}`)
                        .where('timestamp', '==', record.timestamp)
                        .get();
                    
                    const batch = db.batch();
                    qtUserDocs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                    // 3. 달란트 회수 및 오늘 참여 상태 초기화 (만약 오늘 작성한 글이라면)
                    const userRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users').doc(record.userId);
                    const userDoc = await userRef.get();
                    
                    if (userDoc.exists) {
                        const currentTalents = userDoc.data().talents || 0;
                        const currentTotalTalents = userDoc.data().totalTalents !== undefined ? userDoc.data().totalTalents : currentTalents;
                        
                        const isSundayRecord = new Date(record.rawDate).getDay() === 0;
                        const deductionAmount = isSundayRecord ? 60 : 50;
                        
                        const newTalents = Math.max(0, currentTalents - deductionAmount); 
                        const newTotalTalents = Math.max(0, currentTotalTalents - deductionAmount);
                        
                        const updates = { 
                            talents: newTalents,
                            totalTalents: newTotalTalents
                        };
                        
                        // 삭제한 기록이 오늘 한 묵상이었다면, 참여 상태를 초기화하여 다시 할 수 있게 해줌
                        if (userDoc.data().lastQtDate === record.rawDate) {
                            updates.lastQtDate = ""; 
                        }
                        
                        await userRef.set(updates, { merge: true });
                    }

                    setAdminAction(null);
                } catch (error) {
                    console.error("QT Delete Error:", error);
                    showToast("묵상 기록 삭제 중 오류가 발생했습니다.");
                }
            };

            // 상품 신청 삭제 핸들러
            const handleDeleteRequest = async () => {
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('item_requests').doc(adminAction.req.id).delete();
                    setAdminAction(null);
                } catch (error) {
                    console.error("Request Delete Error:", error);
                    showToast("신청 내역 삭제 중 오류가 발생했습니다.");
                }
            };

            // 출석 달란트 지급 핸들러
            const handleGiveAttendance = async (user) => {
                try {
                    const sundayStr = getRecentSundayStr(); // 이번 주 일요일 날짜 가져오기
                    const newTalents = (user.talents || 0) + 10;
                    const newTotal = (user.totalTalents !== undefined ? user.totalTalents : (user.talents || 0)) + 10;
                    
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users').doc(user.id).set({
                        talents: newTalents,
                        totalTalents: newTotal,
                        lastAttendanceDate: sundayStr // 일요일 날짜로 저장
                    }, { merge: true });
                    showToast(`${user.name} 학생에게 출석 10D를 지급했습니다.`);
                } catch (error) {
                    console.error(error);
                    showToast("출석 달란트 지급 중 오류가 발생했습니다.");
                }
            };

            // 출석 달란트 취소 핸들러
            const handleCancelAttendance = async (user) => {
                try {
                    const newTalents = Math.max(0, (user.talents || 0) - 10);
                    const newTotal = Math.max(0, (user.totalTalents !== undefined ? user.totalTalents : (user.talents || 0)) - 10);
                    
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users').doc(user.id).set({
                        talents: newTalents,
                        totalTalents: newTotal,
                        lastAttendanceDate: ""
                    }, { merge: true });
                    showToast(`${user.name} 학생의 출석 달란트를 취소했습니다.`);
                } catch (error) {
                    console.error(error);
                    showToast("취소 중 오류가 발생했습니다.");
                }
            };
            
            // 출석부용 학년별 그룹화
            const usersByGrade = allUsers.reduce((acc, user) => {
                const g = user.grade || '미지정';
                if (!acc[g]) acc[g] = [];
                acc[g].push(user);
                return acc;
            }, {});
            const gradeOrderForAtt = ["중1", "중2", "중3", "고1", "고2", "고3", "교사", "교역자", "미지정"];
            const sortedGradesForAtt = Object.keys(usersByGrade).sort((a, b) => {
                let idxA = gradeOrderForAtt.indexOf(a);
                let idxB = gradeOrderForAtt.indexOf(b);
                if(idxA === -1) idxA = 999;
                if(idxB === -1) idxB = 999;
                return idxA - idxB;
            });

            return (
                <div className="absolute inset-0 z-50 bg-white flex flex-col animate-fadeIn">
                    {/* 상단 헤더 & 탭 */}
                    <div className="px-6 py-4 border-b border-gray-100 flex flex-col bg-white sticky top-0 pt-safe z-10 shadow-sm">
                        <div className="flex justify-between items-center mb-3">
                            <h2 className="text-xl font-bold text-gray-800">관리자 모드</h2>
                            <button onClick={onClose} className="p-2 bg-gray-100 rounded-full"><Icons.X className="w-5 h-5 text-gray-600" /></button>
                        </div>
                        <div className="grid grid-cols-4 gap-2">
                            <button onClick={() => setActiveTab('qt')} className={`py-2 rounded-lg text-xs font-bold transition-colors ${activeTab === 'qt' ? 'bg-purple-50 text-purple-600' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}`}>묵상</button>
                            <button onClick={() => setActiveTab('users')} className={`py-2 rounded-lg text-xs font-bold transition-colors ${activeTab === 'users' ? 'bg-indigo-50 text-indigo-600' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}`}>회원</button>
                            <button onClick={() => setActiveTab('attendance')} className={`py-2 rounded-lg text-xs font-bold transition-colors ${activeTab === 'attendance' ? 'bg-green-50 text-green-600' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}`}>출석부</button>
                            <button onClick={() => setActiveTab('requests')} className={`py-2 rounded-lg text-xs font-bold transition-colors ${activeTab === 'requests' ? 'bg-amber-50 text-amber-600' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}`}>상품신청</button>
                        </div>
                    </div>
                    
                    {/* 내용 영역 */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 pb-safe">
                        
                        {/* 탭 1. 묵상 기록 */}
                        {activeTab === 'qt' && (
                            isLoadingQt ? (
                                <div className="text-center mt-10"><Icons.Loader className="w-8 h-8 text-purple-500 animate-spin mx-auto mb-2"/><p className="text-gray-500">데이터를 불러오는 중...</p></div>
                            ) : Object.keys(groupedQt).length === 0 ? (
                                <p className="text-center text-gray-500 mt-10">아직 작성된 묵상이 없습니다.</p>
                            ) : (
                                sortedQtGroups.map((group) => {
                                    const recordCount = Object.values(groupedQt[group]).reduce((sum, records) => sum + records.length, 0);
                                    return (
                                        <div key={group} className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-2">
                                            <div onClick={() => toggleQtGroup(group)} className="p-4 flex justify-between items-center cursor-pointer bg-white hover:bg-gray-50 transition-colors">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-bold text-sm">
                                                        {group === '기타' ? '기타' : group.charAt(0) + group.split(' ')[1].charAt(0)}
                                                    </div>
                                                    <div>
                                                        <span className="font-bold text-gray-800">{group}</span>
                                                        <span className="text-xs text-gray-500 block">총 {recordCount}개의 묵상</span>
                                                    </div>
                                                </div>
                                                {openQtGroups[group] ? <Icons.ChevronUp className="w-5 h-5 text-gray-400" /> : <Icons.ChevronDown className="w-5 h-5 text-gray-400" />}
                                            </div>
                                            
                                            {openQtGroups[group] && (
                                                <div className="bg-gray-50 p-3 space-y-3 border-t border-gray-100">
                                                    {Object.keys(groupedQt[group]).map((name) => {
                                                        const user = allUsers.find(u => u.name === name);
                                                        const roleTitle = user && ['교사', '교역자'].includes(user.grade) ? user.grade : '학생';

                                                        return (
                                                            <div key={name} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                                                <div onClick={() => toggleFolder(group + '_' + name)} className="p-3 flex justify-between items-center cursor-pointer bg-white hover:bg-gray-50 transition-colors">
                                                                    <div className="flex items-center gap-2">
                                                                        <div className="w-8 h-8 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center font-bold text-xs">{name.slice(0, 1)}</div>
                                                                        <div>
                                                                            <span className="font-bold text-gray-700 text-sm">{name} {roleTitle}</span>
                                                                            <span className="text-xs text-gray-400 ml-2">{groupedQt[group][name].length}개</span>
                                                                        </div>
                                                                    </div>
                                                                    {openFolders[group + '_' + name] ? <Icons.ChevronUp className="w-4 h-4 text-gray-400" /> : <Icons.ChevronDown className="w-4 h-4 text-gray-400" />}
                                                                </div>
                                                                {openFolders[group + '_' + name] && (
                                                                    <div className="p-3 space-y-3 border-t border-gray-100 bg-gray-50">
                                                                        {groupedQt[group][name].map((record, idx) => (
                                                                            <div key={idx} className="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                                                                                <div className="flex justify-between items-center mb-2">
                                                                                    <div className="flex flex-col">
                                                                                        <span className="text-purple-600 font-bold text-xs">{record.date}</span>
                                                                                        <span className="text-[10px] text-gray-400">{record.timestamp}</span>
                                                                                    </div>
                                                                                    <button onClick={() => setAdminAction({ type: 'delete_qt', record })} className="text-[10px] text-red-500 font-bold px-2 py-1 bg-red-50 rounded hover:bg-red-100 flex items-center gap-1 shadow-sm shrink-0">
                                                                                        <Icons.AlertTriangle className="w-3 h-3" /> 삭제
                                                                                    </button>
                                                                                </div>
                                                                                <div className="space-y-2 mt-2">
                                                                                    <div><p className="text-[10px] text-gray-500 mb-0.5">묵상하기 (Q1)</p><p className="text-xs text-gray-800">{record.meditation}</p></div>
                                                                                    {record.comfort && record.comfort.trim() !== '' && (
                                                                                        <div><p className="text-[10px] text-gray-500 mb-0.5">결단 및 다짐 (Q2)</p><p className="text-xs text-gray-800">{record.comfort}</p></div>
                                                                                    )}
                                                                                    <div><p className="text-[10px] text-gray-500 mb-0.5">기도</p><p className="text-xs text-gray-800">{record.prayer}</p></div>
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })
                            )
                        )}

                        {/* 탭 2. 회원 관리 */}
                        {activeTab === 'users' && (
                            isLoadingUsers ? (
                                <div className="text-center mt-10"><Icons.Loader className="w-8 h-8 text-indigo-500 animate-spin mx-auto mb-2"/><p className="text-gray-500">회원 정보를 불러오는 중...</p></div>
                            ) : allUsers.length === 0 ? (
                                <p className="text-center text-gray-500 mt-10">가입한 회원이 없습니다.</p>
                            ) : (
                                sortedGroups.map((group) => (
                                    <div key={group} className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                        <div onClick={() => toggleGroup(group)} className="p-4 flex justify-between items-center cursor-pointer bg-white hover:bg-gray-50 transition-colors">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold text-sm">
                                                    {group === '기타' ? '기타' : group.charAt(0) + group.split(' ')[1].charAt(0)}
                                                </div>
                                                <div>
                                                    <span className="font-bold text-gray-800">{group}</span>
                                                    <span className="text-xs text-gray-500 block">총 {groupedUsers[group].length}명</span>
                                                </div>
                                            </div>
                                            {openGroups[group] ? <Icons.ChevronUp className="w-5 h-5 text-gray-400" /> : <Icons.ChevronDown className="w-5 h-5 text-gray-400" />}
                                        </div>
                                        {openGroups[group] && (
                                            <div className="bg-gray-50 p-2 space-y-2 border-t border-gray-100">
                                                {groupedUsers[group].map((user) => (
                                                    <div key={user.id} className="bg-white rounded-xl border border-gray-200 overflow-hidden">
                                                        <div onClick={() => toggleUserDetail(user.id)} className="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-50">
                                                            <div className="flex items-center gap-2">
                                                                <div className="relative">
                                                                    {user.profileImage ? (
                                                                        <img src={user.profileImage} alt="profile" className="w-8 h-8 rounded-full object-cover border border-gray-200" />
                                                                    ) : (
                                                                        <Icons.User className="w-4 h-4 text-gray-400" />
                                                                    )}
                                                                </div>
                                                                <span className="font-bold text-gray-700">{user.name}</span>
                                                                <span className="text-xs text-gray-400">({user.gender || '미상'})</span>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <span className="text-xs font-bold text-yellow-600 bg-yellow-50 px-2 py-1 rounded-md">{user.talents || 0} D</span>
                                                                {openUserDetail[user.id] ? <Icons.ChevronUp className="w-4 h-4 text-gray-400" /> : <Icons.ChevronDown className="w-4 h-4 text-gray-400" />}
                                                            </div>
                                                        </div>
                                                        {openUserDetail[user.id] && (
                                                            <div className="p-4 bg-gray-50 border-t border-gray-100 text-sm space-y-2">
                                                                <div className="flex justify-between items-center pb-2 border-b border-gray-200 border-dashed">
                                                                    <span className="text-gray-500 font-medium">아이디</span>
                                                                    <span className="font-bold text-gray-800">{user.id}</span>
                                                                </div>
                                                                <div className="flex justify-between items-center pb-2 border-b border-gray-200 border-dashed">
                                                                    <span className="text-gray-500 font-medium">전화번호</span>
                                                                    <span className="font-bold text-gray-800">{user.phone || '미입력'}</span>
                                                                </div>
                                                                <div className="flex justify-between items-center pb-2 border-b border-gray-200 border-dashed">
                                                                    <span className="text-gray-500 font-medium">현재 달란트</span>
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="font-bold text-yellow-600">{user.talents || 0} D</span>
                                                                        <button onClick={() => setAdminAction({ type: 'edit_talent', user, tempTalent: user.talents || 0 })} className="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-md font-bold shadow-sm">수정</button>
                                                                    </div>
                                                                </div>
                                                                <div className="flex justify-between items-center pb-2 border-b border-gray-200 border-dashed">
                                                                    <span className="text-gray-500 font-medium">누적 달란트</span>
                                                                    <span className="font-bold text-amber-600">{user.totalTalents !== undefined ? user.totalTalents : (user.talents || 0)} D</span>
                                                                </div>
                                                                <div className="flex justify-between items-center pb-2 border-b border-gray-200 border-dashed">
                                                                    <span className="text-gray-500 font-medium">최근 QT 참여일</span>
                                                                    <span className="font-bold text-purple-600">{user.lastQtDate || '기록 없음'}</span>
                                                                </div>
                                                                <div className="flex justify-between items-center">
                                                                    <span className="text-gray-500 font-medium">가입일시</span>
                                                                    <span className="font-bold text-gray-600 text-xs">{new Date(user.createdAt).toLocaleString('ko-KR')}</span>
                                                                </div>
                                                                <div className="pt-2 flex justify-end">
                                                                    <button onClick={() => setAdminAction({ type: 'delete_user', user })} className="text-xs text-red-500 font-bold px-3 py-1.5 bg-red-50 rounded-md hover:bg-red-100 flex items-center gap-1 shadow-sm">
                                                                        <Icons.AlertTriangle className="w-3 h-3" /> 회원 삭제
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ))
                            )
                        )}

                        {/* 탭 3. 출석부 관리 */}
                        {activeTab === 'attendance' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center px-1">
                                    <h3 className="font-bold text-gray-800">주일 출석 체크</h3>
                                    <p className="text-xs text-gray-500">출석한 학생에게 10D 지급</p>
                                </div>
                                {sortedGradesForAtt.map(grade => (
                                    <div key={grade} className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                        <div onClick={() => toggleGroup(`att_${grade}`)} className="p-3 flex justify-between items-center cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors border-b border-gray-100">
                                            <span className="font-bold text-gray-700 text-sm">{grade} <span className="text-xs font-normal text-gray-500 ml-1">({usersByGrade[grade].length}명)</span></span>
                                            {openGroups[`att_${grade}`] ? <Icons.ChevronUp className="w-4 h-4 text-gray-400" /> : <Icons.ChevronDown className="w-4 h-4 text-gray-400" />}
                                        </div>
                                        {openGroups[`att_${grade}`] && (
                                            <div className="divide-y divide-gray-50">
                                                {usersByGrade[grade].map(user => {
                                                    const sundayStr = getRecentSundayStr(); // 이번 주 일요일 날짜
                                                    const isAttended = user.lastAttendanceDate === sundayStr; // 이번 주에 지급했는지 확인
                                                    return (
                                                        <div key={user.id} className="p-3 flex justify-between items-center hover:bg-gray-50 transition-colors">
                                                            <div className="flex items-center gap-2">
                                                                <div className="relative">
                                                                    {user.profileImage ? (
                                                                        <img src={user.profileImage} alt="profile" className="w-8 h-8 rounded-full object-cover border border-gray-200" />
                                                                    ) : (
                                                                        <Icons.User className="w-4 h-4 text-gray-400" />
                                                                    )}
                                                                </div>
                                                                <div>
                                                                    <span className="font-bold text-gray-800 text-sm block">{user.name}</span>
                                                                    <span className="text-[10px] text-gray-400">{user.grade || '학년미상'} | {user.gender || '성별미상'}</span>
                                                                </div>
                                                            </div>
                                                            {isAttended ? (
                                                                <button onClick={() => handleCancelAttendance(user)} className="text-xs px-3 py-1.5 bg-gray-100 text-gray-500 rounded-lg font-bold border border-gray-200 shadow-sm hover:bg-gray-200 transition-colors">지급 완료(취소)</button>
                                                            ) : (
                                                                <button onClick={() => handleGiveAttendance(user)} className="text-xs px-3 py-1.5 bg-green-50 text-green-600 rounded-lg font-bold border border-green-200 shadow-sm hover:bg-green-100 transition-colors">출석 10D 지급</button>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* 탭 4. 상품 신청 목록 */}
                        {activeTab === 'requests' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center px-1">
                                    <h3 className="font-bold text-gray-800">상품 신청 내역</h3>
                                    <span className="text-xs font-bold text-amber-600 bg-amber-100 px-2 py-1 rounded-full">총 {allRequests.length}건</span>
                                </div>
                                {isLoadingRequests ? (
                                    <div className="text-center mt-10"><Icons.Loader className="w-8 h-8 text-amber-500 animate-spin mx-auto mb-2"/><p className="text-gray-500">데이터를 불러오는 중...</p></div>
                                ) : allRequests.length === 0 ? (
                                    <p className="text-center text-gray-500 mt-10 bg-white p-6 rounded-2xl border border-gray-100">아직 들어온 상품 신청이 없습니다.</p>
                                ) : (
                                    <div className="space-y-3">
                                        {allRequests.map(req => (
                                            <div key={req.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                                                <div>
                                                    <p className="font-bold text-gray-800 text-sm mb-1">{req.itemName}</p>
                                                    <p className="text-xs text-gray-500">{req.userName} 학생 <span className="text-gray-300 mx-1">|</span> {req.dateStr}</p>
                                                </div>
                                                <button onClick={() => setAdminAction({ type: 'delete_request', req })} className="text-xs font-bold text-gray-400 bg-gray-50 border border-gray-200 px-3 py-1.5 rounded-lg hover:bg-gray-100 transition-colors">삭제</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                    </div>

                    {/* Admin 모달들 (달란트 수정, 회원 삭제, 묵상 삭제, 상품신청 삭제) */}
                    {adminAction && adminAction.type === 'edit_talent' && (
                        <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm animate-fadeIn px-4">
                            <div className="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
                                <h3 className="font-bold text-lg mb-2 text-gray-800">{adminAction.user.name} 달란트 수정</h3>
                                <p className="text-sm text-gray-500 mb-4">지급하거나 차감하여 새로운 달란트 값을 맞춰주세요.</p>
                                <input 
                                    type="number" 
                                    value={adminAction.tempTalent} 
                                    onChange={e => setAdminAction({...adminAction, tempTalent: e.target.value})} 
                                    className="w-full border border-gray-200 bg-gray-50 p-4 rounded-xl mb-6 text-center font-bold text-2xl text-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400" 
                                />
                                <div className="flex gap-3">
                                    <button onClick={() => setAdminAction(null)} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-colors">취소</button>
                                    <button onClick={handleUpdateTalent} className="flex-1 py-3 bg-yellow-500 text-white font-bold rounded-xl shadow-md hover:bg-yellow-600 transition-colors">저장하기</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {adminAction && adminAction.type === 'delete_user' && (
                        <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm animate-fadeIn px-4">
                            <div className="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
                                <div className="w-14 h-14 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.AlertTriangle className="w-7 h-7 text-red-500" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-center text-gray-800">{adminAction.user.name} 회원 삭제</h3>
                                <p className="text-sm text-gray-500 mb-6 text-center">정말로 이 회원을 영구적으로 삭제하시겠습니까?<br/>삭제 후에는 복구할 수 없습니다.</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setAdminAction(null)} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-colors">취소</button>
                                    <button onClick={handleDeleteUser} className="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl shadow-md hover:bg-red-600 transition-colors">삭제하기</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {adminAction && adminAction.type === 'delete_qt' && (
                        <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm animate-fadeIn px-4">
                            <div className="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
                                <div className="w-14 h-14 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.AlertTriangle className="w-7 h-7 text-red-500" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-center text-gray-800">묵상 기록 삭제</h3>
                                <p className="text-sm text-gray-500 mb-6 text-center">정말로 이 묵상 기록을 삭제하시겠습니까?<br/>삭제 시 지급된 <b>50 달란트가 회수</b>됩니다.</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setAdminAction(null)} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-colors">취소</button>
                                    <button onClick={handleDeleteQt} className="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl shadow-md hover:bg-red-600 transition-colors">삭제 및 회수</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {adminAction && adminAction.type === 'delete_request' && (
                        <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm animate-fadeIn px-4">
                            <div className="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl text-center">
                                <h3 className="font-bold text-lg mb-2 text-gray-800">신청 내역 삭제</h3>
                                <p className="text-sm text-gray-500 mb-6">'{adminAction.req.itemName}' 신청 내역을<br/>목록에서 삭제하시겠습니까?</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setAdminAction(null)} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-colors">취소</button>
                                    <button onClick={handleDeleteRequest} className="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl shadow-md hover:bg-red-600 transition-colors">삭제</button>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const App = () => {
            const [toastMessage, setToastMessage] = useState(null);
            const showToast = (msg) => {
                setToastMessage(msg);
                setTimeout(() => setToastMessage(null), 3000);
            };

            const [fbUser, setFbUser] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [view, setView] = useState('login');
            const [isLoading, setIsLoading] = useState(true);
            const [authError, setAuthError] = useState(null);

            // App State
            const [activeTab, setActiveTab] = useState('qt'); // qt, event, ranking, shop, profile
            const [talents, setTalents] = useState(0);
            const [completedToday, setCompletedToday] = useState(false);
            const [meditation, setMeditation] = useState('');
            const [comfort, setComfort] = useState(''); // Q2 답변용 상태 변수 추가
            const [prayer, setPrayer] = useState('');
            const [purchasedItems, setPurchasedItems] = useState([]);
            const [qtHistory, setQtHistory] = useState([]);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [todayQT, setTodayQT] = useState(null);
            const [todayQuiz, setTodayQuiz] = useState(null);
            
            // Leaderboard State
            const [leaderboard, setLeaderboard] = useState([]);
            
            // Quiz State
            const [quizCompletedToday, setQuizCompletedToday] = useState(false);

            // Modals & Inputs
            const [showRewardModal, setShowRewardModal] = useState(false);
            const [rewardMessage, setRewardMessage] = useState({ title: "", desc: "", amount: 0 });
            const [showAdminModal, setShowAdminModal] = useState(false);
            const [showAdminLoginModal, setShowAdminLoginModal] = useState(false);
            const [adminPasswordInput, setAdminPasswordInput] = useState('');
            const [purchaseModalItem, setPurchaseModalItem] = useState(null);
            const [useModalItem, setUseModalItem] = useState(null);
            const [teacherPassword, setTeacherPassword] = useState('');
            const [selectedQuizOption, setSelectedQuizOption] = useState(null);
            const [quizSolved, setQuizSolved] = useState(false);
            const [isCorrect, setIsCorrect] = useState(false);
            
            // Item Request State
            const [showItemRequestModal, setShowItemRequestModal] = useState(false);
            const [requestItemName, setRequestItemName] = useState('');
            
            // Profile Image Modal State
            const [showProfileImageModal, setShowProfileImageModal] = useState(false); // 프로필 사진 확대 모달 상태
            
            // Used Items History State
            const [showUsedItems, setShowUsedItems] = useState(false);
            
            // Auth Inputs
            const [inputId, setInputId] = useState('');
            const [inputPw, setInputPw] = useState('');
            const [inputName, setInputName] = useState('');
            const [inputGrade, setInputGrade] = useState('');
            const [inputGender, setInputGender] = useState('');
            const [inputPhone, setInputPhone] = useState('');
            const [keepLoggedIn, setKeepLoggedIn] = useState(true); // 상태 유지 체크박스 상태

            // Auth Init & Logic
            useEffect(() => {
                let isMounted = true;
                
                // 안전장치: 로딩이 너무 오래 걸리면 강제 종료
                const timeoutId = setTimeout(() => {
                    if (isLoading) {
                        setIsLoading(false);
                        // setAuthError("서버 응답이 늦습니다. 다시 시도해주세요."); (선택 사항)
                    }
                }, 3000); // 3초

                if (!isFirebaseInitialized || !auth) {
                    setAuthError("Firebase 설정이 필요합니다 (index.html 수정).");
                    setIsLoading(false);
                    return () => clearTimeout(timeoutId);
                }

                const initAuth = async () => {
                    try {
                        await auth.signInAnonymously();
                    } catch (error) {
                        console.error("Auth Error", error);
                        setAuthError("서버 연결 실패: " + error.code);
                    }
                };
                initAuth();

                const unsubscribe = auth.onAuthStateChanged((user) => {
                    if (!isMounted) return;
                    setFbUser(user);
                    
                    if (user) {
                        setAuthError(null);
                        // localStorage 안전하게 접근
                        let savedUserId = null;
                        try {
                            savedUserId = localStorage.getItem('yebon_teen_qt_user_id') || sessionStorage.getItem('yebon_teen_qt_user_id');
                        } catch (e) { console.error("Storage Error", e); }

                        if (savedUserId) {
                            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users').doc(savedUserId).get()
                            .then(doc => {
                                if (doc.exists) fetchUserData(doc.data());
                                else setIsLoading(false);
                            }).catch(() => setIsLoading(false));
                        } else {
                            setIsLoading(false);
                        }
                    } else {
                        setIsLoading(false);
                    }
                });

                return () => { isMounted = false; unsubscribe(); clearTimeout(timeoutId); };
            }, []);

            // Leaderboard Fetch
            useEffect(() => {
                if (!isFirebaseInitialized || !db || !fbUser) return; // 사용자가 로그인 상태일 때만 가져옴
                
                const unsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users')
                    .onSnapshot(snap => {
                        const users = snap.docs.map(doc => doc.data());
                        const sortedUsers = users.sort((a, b) => {
                            const aTotal = a.totalTalents !== undefined ? a.totalTalents : (a.talents || 0);
                            const bTotal = b.totalTalents !== undefined ? b.totalTalents : (b.talents || 0);
                            return bTotal - aTotal;
                        }).slice(0, 5); // 상위 5명 추출로 변경
                        setLeaderboard(sortedUsers);
                    }, (err) => console.error("Ranking fetch error:", err));
                    
                return () => unsubscribe();
            }, [fbUser]); // fbUser 의존성 추가

            useEffect(() => { setCurrentDate(new Date()); }, []);

            // Handlers
            const handleSignup = async () => {
                if (!isFirebaseInitialized) return setAuthError("Firebase 설정이 필요합니다.");
                if (!fbUser) return setAuthError("서버 연결 중...");
                if (!inputId || !inputPw || !inputName || !inputGrade || !inputGender || !inputPhone) {
                    return setAuthError("모든 정보를 빠짐없이 입력해주세요.");
                }
                
                setIsLoading(true);
                try {
                    const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users').doc(inputId);
                    const snap = await docRef.get();
                    if (snap.exists) { 
                        setAuthError("이미 존재하는 아이디입니다."); 
                        setIsLoading(false); 
                        return; 
                    }
                    const newUser = { 
                        id: inputId, 
                        password: inputPw, 
                        name: inputName, 
                        grade: inputGrade, 
                        gender: inputGender, 
                        phone: inputPhone, 
                        talents: 0, 
                        totalTalents: 0, // 누적 달란트 초기화
                        createdAt: new Date().toISOString() 
                    };
                    await docRef.set(newUser);
                    
                    setIsLoading(false); 
                    
                    showToast("가입이 완료되었습니다! 로그인해주세요.");
                    setView('login'); 
                    setInputId(''); setInputPw(''); setInputName(''); 
                    setInputGrade(''); setInputGender(''); setInputPhone(''); 
                    setAuthError(null);
                } catch (e) { 
                    setAuthError("가입 오류: " + e.message); 
                    setIsLoading(false); 
                }
            };

            const handleLogin = async () => {
                if (!isFirebaseInitialized) return setAuthError("Firebase 설정이 필요합니다.");
                if (!fbUser) return setAuthError("서버 연결 중...");
                if (!inputId || !inputPw) return setAuthError("아이디와 비밀번호를 모두 입력해주세요.");
                
                setIsLoading(true);
                try {
                    const snap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users').doc(inputId).get();
                    if (snap.exists) {
                        const data = snap.data();
                        if (data.password === inputPw) {
                            setAuthError(null);
                            // 로그인 유지 여부에 따라 저장 위치 분기
                            try {
                                if (keepLoggedIn) {
                                    localStorage.setItem('yebon_teen_qt_user_id', data.id);
                                    sessionStorage.removeItem('yebon_teen_qt_user_id');
                                } else {
                                    sessionStorage.setItem('yebon_teen_qt_user_id', data.id);
                                    localStorage.removeItem('yebon_teen_qt_user_id');
                                }
                            } catch(e) { console.error("Storage Error", e); }
                            
                            fetchUserData(data);
                        }
                        else { 
                            setAuthError("비밀번호가 틀렸습니다."); 
                            setIsLoading(false); 
                        }
                    } else { 
                        setAuthError("존재하지 않는 아이디입니다."); 
                        setIsLoading(false); 
                    }
                } catch (e) { 
                    setAuthError("로그인 오류: " + e.message); 
                    setIsLoading(false); 
                }
            };

            const fetchUserData = (userData) => {
                setCurrentUser(userData);
                setTalents(userData.talents || 0);

                const todayStr = getTodayString();

                setView('app');
                
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`items_${userData.id}`)
                  .onSnapshot(snap => setPurchasedItems(snap.docs.map(d => ({ ...d.data(), firestoreId: d.id }))));
                
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`qt_${userData.id}`)
                  .onSnapshot(snap => {
                      const h = snap.docs.map(d => ({ ...d.data(), firestoreId: d.id })).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                      setQtHistory(h);
                  });

                // 실시간으로 유저 정보 업데이트
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users').doc(userData.id)
                  .onSnapshot(doc => { 
                      if(doc.exists) {
                          const data = doc.data();
                          setCurrentUser(data); // 실시간 유저 정보 업데이트 (누적 달란트 포함)
                          setTalents(data.talents || 0); 
                          
                          if (data.lastQuizDate === todayStr) {
                              setQuizCompletedToday(true);
                          } else {
                              setQuizCompletedToday(false);
                          }

                          if (data.lastQtDate === todayStr) {
                              setCompletedToday(true);
                          } else {
                              setCompletedToday(false); // 참여 날짜가 다르면(관리자가 삭제해서 비웠다면) 미완료로 처리
                          }
                      }
                  });
                
                setIsLoading(false);
            };

            const handleLogout = () => { localStorage.removeItem('yebon_teen_qt_user_id'); sessionStorage.removeItem('yebon_teen_qt_user_id'); setCurrentUser(null); setView('login'); setInputId(''); setInputPw(''); setTalents(0); setAuthError(null); };
            const handleAdminAccess = () => { setAdminPasswordInput(''); setShowAdminLoginModal(true); };
            const confirmAdminLogin = () => { if (adminPasswordInput === "100404") { setShowAdminLoginModal(false); setShowAdminModal(true); } else showToast("비밀번호가 틀렸습니다."); };
            
            // 이미지 압축 및 업로드 핸들러
            const handleProfileImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const MAX_WIDTH = 150;
                const MAX_HEIGHT = 150;

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = async () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7); // 70% quality JPG

                        try {
                            setIsLoading(true);
                            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users').doc(currentUser.id).set({
                                profileImage: dataUrl
                            }, { merge: true });
                            showToast("프로필 사진이 업데이트되었습니다!");
                        } catch(err) {
                            console.error("Profile Image Upload Error:", err);
                            showToast("사진 업로드 중 오류가 발생했습니다.");
                        } finally {
                            setIsLoading(false);
                        }
                    };
                };
            };
            
            const confirmPurchase = async () => {
                if (purchaseModalItem && currentUser) { 
                    setIsLoading(true); 
                    try {
                        // 구매 시에는 '현재 달란트(talents)'만 감소시키고 누적(totalTalents)은 그대로 둡니다.
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users').doc(currentUser.id).set({ 
                            talents: talents - purchaseModalItem.cost 
                        }, { merge: true });
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`items_${currentUser.id}`).add({ ...purchaseModalItem, uniqueId: Date.now(), used: false, purchaseDate: new Date().toLocaleDateString() });
                        showToast("구매가 완료되었습니다! MY 탭을 확인해주세요.");
                    } catch(e) { console.error(e); showToast("구매 중 오류가 발생했습니다."); }
                    setIsLoading(false); setPurchaseModalItem(null); 
                }
            };
            const onClickBuy = (item) => { talents >= item.cost ? setPurchaseModalItem(item) : showToast("달란트가 부족합니다!"); };
            
            const onClickUse = (item) => { setUseModalItem(item); setTeacherPassword(''); };
            const confirmUse = async () => {
                if (teacherPassword === "100404") { 
                    setIsLoading(true); 
                    try {
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`items_${currentUser.id}`).doc(useModalItem.firestoreId).set({ used: true, useDate: new Date().toLocaleDateString() }, { merge: true });
                        showToast("선생님 확인이 완료되었습니다!"); 
                    } catch(e) { console.error(e); showToast("오류가 발생했습니다."); }
                    setIsLoading(false); setUseModalItem(null); 
                } else showToast("선생님 확인 비밀번호가 틀렸습니다.");
            };

            const submitItemRequest = async () => {
                if (!requestItemName.trim()) return showToast("상품 이름을 입력해주세요.");
                setIsLoading(true);
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('item_requests').add({
                        userId: currentUser.id,
                        userName: currentUser.name,
                        itemName: requestItemName,
                        createdAt: new Date().getTime(),
                        dateStr: new Date().toLocaleString('ko-KR')
                    });
                    showToast("상품 신청이 완료되었습니다!");
                    setShowItemRequestModal(false);
                    setRequestItemName('');
                } catch (error) {
                    console.error(error);
                    showToast("오류가 발생했습니다.");
                }
                setIsLoading(false);
            };
            
            const handleComplete = async () => {
                if (completedToday) return showToast("이미 완료했습니다.");
                if (meditation.length < 10 || prayer.length < 10) return showToast("내용을 10자 이상 작성해주세요.");
                if (todayQT.questions[1] && comfort.length < 10) return showToast("두 번째 답변도 10자 이상 작성해주세요.");
                setIsLoading(true);
                const todayStr = getTodayString();
                
                const earnedTalents = 50; // 고정 50달란트 (주일 보너스는 출석부에서 선생님이 수동 지급)
                
                const rec = { userId: currentUser.id, name: currentUser.name, date: todayQT.date, rawDate: todayStr, title: todayQT.title, meditation, comfort: todayQT.questions[1] ? comfort : "", prayer, timestamp: new Date().toLocaleString() };
                
                try {
                    const currentTotal = currentUser.totalTalents !== undefined ? currentUser.totalTalents : talents;

                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`qt_${currentUser.id}`).add(rec);
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('all_qt_records').add(rec);
                    
                    // 현재 달란트와 누적 달란트 모두 증가
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users').doc(currentUser.id).set({ 
                        talents: talents + earnedTalents,
                        totalTalents: currentTotal + earnedTalents,
                        lastQtDate: todayStr 
                    }, { merge: true });
                    
                    setCompletedToday(true);
                    setRewardMessage({ title: "참 잘했어요!", desc: "묵상 완료", amount: earnedTalents }); 
                    setShowRewardModal(true); 
                    setTimeout(() => setShowRewardModal(false), 3000);
                } catch(e) { console.error(e); showToast("오류 발생"); }
                setIsLoading(false);
            };
            const handleSubmitQuiz = async () => {
                if (selectedQuizOption === null) return;
                if (quizCompletedToday) return showToast("이미 참여했습니다.");
                setQuizSolved(true);
                const isAnswerCorrect = selectedQuizOption === todayQuiz.answer;
                setIsCorrect(isAnswerCorrect);
                
                try {
                    const todayStr = getTodayString();
                    const updates = { lastQuizDate: todayStr };
                    if (isAnswerCorrect) {
                        updates.talents = talents + 10;
                        const currentTotal = currentUser.totalTalents !== undefined ? currentUser.totalTalents : talents;
                        updates.totalTalents = currentTotal + 10; // 정답 시 누적 달란트도 10 증가
                    }
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users').doc(currentUser.id).set(updates, { merge: true });
                    setQuizCompletedToday(true);
                    
                    if (isAnswerCorrect) {
                        setRewardMessage({ title: "정답!", desc: "퀴즈 정답", amount: 10 }); 
                        setShowRewardModal(true); 
                        setTimeout(() => setShowRewardModal(false), 2000);
                    }
                } catch(e) { console.error(e); }
            };

            // DB 아이콘 데이터 직렬화 수정 (React Component -> String 기반으로 변경)
            // shopItems is now global

            useEffect(() => {
                const start = new Date(currentDate.getFullYear(), 0, 0);
                const diff = currentDate - start;
                const oneDay = 1000 * 60 * 60 * 24;
                const dayOfYear = Math.floor(diff / oneDay);
                
                const fallbackQT = { ...qtDatabase[dayOfYear % qtDatabase.length], date: currentDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' }) };
                const fallbackQuiz = quizDatabase[dayOfYear % quizDatabase.length];

                // 파이어베이스에서 오늘 날짜의 묵상 데이터가 있는지 확인하여 가져오기
                const fetchDailyContent = async () => {
                    if (!fbUser || !db) {
                        setTodayQT(fallbackQT);
                        setTodayQuiz(fallbackQuiz);
                        setQuizSolved(false); 
                        setSelectedQuizOption(null);
                        return;
                    }
                    
                    try {
                        const todayStr = getTodayString();
                        const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('daily_contents').doc(todayStr).get();
                        
                        if (doc.exists) {
                            const data = doc.data();
                            setTodayQT({ ...data.qt, date: currentDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' }) });
                            setTodayQuiz(data.quiz);
                        } else {
                            // DB에 등록된 오늘의 말씀이 없다면 기본 예시(50개 중 하나) 출력
                            setTodayQT(fallbackQT);
                            setTodayQuiz(fallbackQuiz);
                        }
                    } catch (error) {
                        console.error("Daily Content Load Error:", error);
                        setTodayQT(fallbackQT);
                        setTodayQuiz(fallbackQuiz);
                    }
                    setQuizSolved(false); 
                    setSelectedQuizOption(null);
                };

                fetchDailyContent();
            }, [currentDate, fbUser]); // fbUser(로그인 상태)가 변경될 때 최신 데이터를 한 번 더 불러옵니다.

            // Handlers
            const TabButton = ({ id, icon, label }) => (
                <button onClick={() => setActiveTab(id)} className={`flex flex-col items-center justify-center w-full py-2 transition-all duration-300 ${activeTab === id ? 'text-purple-600 scale-110' : 'text-gray-400 hover:text-purple-400'}`}>
                    {icon} <span className="text-[10px] mt-1 font-medium">{label}</span>
                </button>
            );

            if (isLoading) return <div className="fixed inset-0 bg-purple-50 flex flex-col items-center justify-center z-50"><Icons.Loader className="w-10 h-10 text-purple-500 animate-spin mb-4"/><p className="text-purple-600 font-bold">로딩중...</p></div>;

            if (view !== 'app') {
                return (
                    <div className="fixed inset-0 bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 flex items-center justify-center p-4">
                        {toastMessage && <div className="fixed top-10 left-1/2 transform -translate-x-1/2 z-[9999] bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-sm animate-fadeIn text-center min-w-[250px]">{toastMessage}</div>}
                        <div className="w-full max-w-sm max-h-[90vh] overflow-y-auto scrollbar-hide bg-white/90 backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-white/50 animate-fadeIn">
                            <h1 className="text-3xl font-bold text-center bg-gradient-to-r from-purple-600 to-pink-500 bg-clip-text text-transparent mb-2">예본TeenQT</h1>
                            <p className="text-gray-500 text-sm text-center mb-8">청소년부 매일 묵상</p>
                            {authError && <div className="bg-red-50 text-red-700 px-4 py-3 rounded-xl mb-6 text-sm font-bold text-center shadow-sm">{authError}</div>}
                            <div className="space-y-4">
                                {view === 'signup' && (
                                    <>
                                        <input type="text" value={inputName} onChange={e => setInputName(e.target.value)} className="w-full bg-purple-50/50 border border-purple-100 rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-purple-300" placeholder="이름" />
                                        <select value={inputGrade} onChange={e => setInputGrade(e.target.value)} className={`w-full bg-purple-50/50 border border-purple-100 rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-purple-300 ${!inputGrade ? 'text-gray-400' : 'text-gray-700'}`}>
                                            <option value="" disabled>소속 (학년/직분) 선택</option>
                                            <option value="중1">중1</option>
                                            <option value="중2">중2</option>
                                            <option value="중3">중3</option>
                                            <option value="고1">고1</option>
                                            <option value="고2">고2</option>
                                            <option value="고3">고3</option>
                                            <option value="교사">교사</option>
                                            <option value="교역자">교역자</option>
                                        </select>
                                        <select value={inputGender} onChange={e => setInputGender(e.target.value)} className={`w-full bg-purple-50/50 border border-purple-100 rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-purple-300 ${!inputGender ? 'text-gray-400' : 'text-gray-700'}`}>
                                            <option value="" disabled>성별 선택</option>
                                            <option value="남성">남성</option>
                                            <option value="여성">여성</option>
                                        </select>
                                        <input type="tel" value={inputPhone} onChange={e => setInputPhone(e.target.value)} className="w-full bg-purple-50/50 border border-purple-100 rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-purple-300" placeholder="전화번호 (예: 010-1234-5678)" />
                                    </>
                                )}
                                <input type="text" value={inputId} onChange={e => setInputId(e.target.value)} className="w-full bg-purple-50/50 border border-purple-100 rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-purple-300" placeholder="아이디" />
                                <input type="password" value={inputPw} onChange={e => setInputPw(e.target.value)} className="w-full bg-purple-50/50 border border-purple-100 rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-purple-300" placeholder="비밀번호" />
                                {view === 'login' && (
                                    <div className="flex items-center gap-2 px-1">
                                        <input type="checkbox" id="keepLoggedIn" checked={keepLoggedIn} onChange={(e) => setKeepLoggedIn(e.target.checked)} className="w-4 h-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500" />
                                        <label htmlFor="keepLoggedIn" className="text-sm text-gray-600 cursor-pointer select-none">로그인 상태 유지</label>
                                    </div>
                                )}
                                <button onClick={view === 'login' ? handleLogin : handleSignup} disabled={!isFirebaseInitialized} className={`w-full py-3.5 rounded-xl font-bold text-lg shadow-lg text-white ${isFirebaseInitialized ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-gray-400'}`}>{view === 'login' ? '로그인' : '회원가입'}</button>
                                <div className="text-center mt-4"><button onClick={() => { setView(view === 'login' ? 'signup' : 'login'); setInputId(''); setInputPw(''); setInputName(''); setInputGrade(''); setInputGender(''); setInputPhone(''); setAuthError(null); }} className="text-sm text-gray-500 underline">{view === 'login' ? '회원가입하기' : '로그인하기'}</button></div>
                            </div>
                        </div>
                    </div>
                );
            }

            // 모바일 화면에서 하단 바가 잘리지 않도록 Flex 구조로 안정화
            return (
                <div className="fixed inset-0 bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 flex justify-center sm:items-center">
                    {toastMessage && <div className="fixed top-10 left-1/2 transform -translate-x-1/2 z-[9999] bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-sm animate-fadeIn text-center min-w-[250px]">{toastMessage}</div>}
                    <div className="w-full h-full sm:h-[850px] sm:max-w-md bg-white/80 backdrop-blur-xl sm:rounded-[2.5rem] shadow-2xl overflow-hidden relative border-0 sm:border border-white/50 flex flex-col h-dvh">
                        
                        {/* 헤더 */}
                        <div className="px-6 pt-safe pt-6 pb-4 flex justify-between items-center bg-white/50 backdrop-blur-sm sticky top-0 z-10 shrink-0 border-b border-gray-100">
                            <div><h1 className="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-500 bg-clip-text text-transparent">예본TeenQT</h1><p className="text-xs text-gray-500 font-medium">환영합니다, {currentUser?.name}님!</p></div>
                            <div className="flex items-center gap-2 bg-yellow-100/80 px-3 py-1.5 rounded-full shadow-sm border border-yellow-200"><Icons.Star className="w-4 h-4 text-yellow-500 fill-yellow-500" /><span className="font-bold text-yellow-700 text-sm">{talents} D</span></div>
                        </div>

                        {/* 메인 콘텐츠 (스크롤 영역) - 전체 파스텔 톤 적용 */}
                        <div className="flex-1 overflow-y-auto scrollbar-hide px-6 py-4 space-y-6">
                            {activeTab === 'qt' && (
                                <div className="animate-fadeIn space-y-6">
                                    <div className="bg-indigo-50 rounded-2xl p-5 shadow-sm border border-indigo-100"><p className="text-sm text-indigo-500 mb-1 font-medium">{todayQT.date}</p><h2 className="text-2xl font-bold text-indigo-900 mb-2">{todayQT.title}</h2><div className="flex items-center gap-2 text-indigo-600 font-semibold text-sm"><Icons.BookOpen className="w-4 h-4"/>{todayQT.passage}</div></div>
                                    <div className="bg-sky-50 rounded-2xl p-6 shadow-sm border border-sky-100"><p className="text-sky-900 font-serif text-lg leading-relaxed">"{todayQT.scripture}"</p></div>
                                    <div className="space-y-2"><h3 className="font-bold text-gray-700 flex items-center gap-2"><span className="w-1.5 h-6 bg-pink-400 rounded-full"></span>말씀 묵상</h3><p className="text-pink-900 text-sm bg-pink-50 p-4 rounded-xl border border-pink-100 leading-relaxed">{todayQT.commentary}</p></div>
                                    {!completedToday ? (
                                        <div className="space-y-4 pb-4">
                                            <div className="bg-amber-50 p-4 rounded-xl shadow-sm border border-amber-100 space-y-4">
                                                <div>
                                                    <p className="text-sm font-bold text-amber-900 mb-1">묵상하기</p>
                                                    <p className="text-xs text-amber-700 font-medium mb-2">Q1. {todayQT.questions[0]}</p>
                                                    <textarea className="w-full bg-white border border-amber-100 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-amber-300" rows="3" value={meditation} onChange={e => setMeditation(e.target.value)} placeholder="10자 이상..." />
                                                </div>

                                                {todayQT.questions[1] && (
                                                    <div className="pt-2 border-t border-amber-200/50">
                                                        <p className="text-sm font-bold text-amber-900 mb-1">결단 및 다짐</p>
                                                        <p className="text-xs text-amber-700 font-medium mb-2">Q2. {todayQT.questions[1]}</p>
                                                        <textarea className="w-full bg-white border border-amber-100 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-amber-300" rows="3" value={comfort} onChange={e => setComfort(e.target.value)} placeholder="10자 이상..." />
                                                    </div>
                                                )}
                                            </div>
                                            
                                            <div className="bg-violet-50 p-4 rounded-xl shadow-sm border border-violet-100">
                                                <p className="text-sm font-bold text-violet-900 mb-2">기도하기</p>
                                                <textarea className="w-full bg-white border border-violet-100 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-violet-300" rows="2" value={prayer} onChange={e => setPrayer(e.target.value)} placeholder="10자 이상..." />
                                            </div>
                                            <button onClick={handleComplete} className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 rounded-2xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 mb-4 active:scale-95 transition-transform">
                                                <Icons.CheckCircle className="w-5 h-5"/>완료하고 {currentDate.getDay() === 0 ? '60' : '50'}달란트 받기
                                            </button>
                                        </div>
                                    ) : <div className="bg-green-50 p-6 rounded-2xl text-center border border-green-100"><Icons.CheckCircle className="w-12 h-12 text-green-600 mx-auto mb-2"/><h3 className="font-bold text-green-800">오늘 묵상 완료!</h3><p className="text-sm text-green-600">내일 또 만나요 ✨</p></div>}
                                </div>
                            )}

                            {activeTab === 'event' && (
                                <div className="animate-fadeIn space-y-6">
                                    <div className="text-center mb-6"><span className="px-3 py-1 bg-orange-100 text-orange-600 rounded-full text-xs font-bold mb-2 inline-block">EVENT</span><h2 className="text-2xl font-bold text-gray-800">매일 성경 퀴즈</h2></div>
                                    <div className="bg-orange-50 rounded-3xl p-6 shadow-sm border border-orange-100 relative overflow-hidden">
                                        <h3 className="text-lg font-bold text-orange-900 text-center mb-6 relative z-10">Q. {todayQuiz.question}</h3>
                                        <div className="space-y-3 relative z-10">
                                            {todayQuiz.options.map((opt, idx) => (
                                                <button key={idx} disabled={quizSolved || quizCompletedToday} onClick={() => setSelectedQuizOption(idx)} className={`w-full py-4 px-4 rounded-xl text-left font-medium flex justify-between transition-all ${quizSolved ? (idx === todayQuiz.answer ? "bg-green-100 text-green-800 border border-green-200" : idx === selectedQuizOption ? "bg-red-50 text-red-500 border border-red-200" : "bg-white/60 text-gray-400") : (selectedQuizOption === idx ? "bg-orange-200 text-orange-900 border border-orange-300 shadow-inner" : "bg-white text-gray-700 hover:bg-orange-100/50 border border-white shadow-sm")}`}>
                                                    <span>{idx+1}. {opt}</span>
                                                    {quizSolved && idx === todayQuiz.answer && <Icons.CheckCircle className="w-5 h-5"/>}
                                                </button>
                                            ))}
                                        </div>
                                        {!quizSolved ? (
                                            quizCompletedToday ? 
                                            <div className="mt-6 p-4 rounded-xl text-center bg-white/60 text-orange-700 font-bold relative z-10 border border-orange-100">이미 참여했습니다! (내일 또 만나요)</div> :
                                            <button onClick={handleSubmitQuiz} disabled={selectedQuizOption === null} className={`w-full mt-6 py-3 rounded-xl font-bold text-white shadow-md relative z-10 ${selectedQuizOption === null ? 'bg-gray-300' : 'bg-gradient-to-r from-orange-400 to-red-400'}`}>정답 제출</button>
                                        ) : <div className={`mt-6 p-4 rounded-xl text-center relative z-10 border ${isCorrect ? "bg-green-50 border-green-100 text-green-800" : "bg-red-50 border-red-100 text-red-800"}`}><p className="font-bold mb-1">{isCorrect ? "정답! 🎉" : "아쉽네요"}</p><p className="text-sm">{todayQuiz.explanation}</p></div>}
                                    </div>
                                </div>
                            )}
                            
                            {activeTab === 'ranking' && (
                                <div className="animate-fadeIn space-y-6">
                                    <div className="text-center mb-6">
                                        <span className="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold mb-2 inline-block">명예의 전당</span>
                                        <h2 className="text-2xl font-bold text-gray-800">달란트 랭킹 TOP 5</h2>
                                        <p className="text-xs text-gray-500 mt-2">달란트를 가장 많이 모은 상위 5명입니다! (달란트는 비공개)</p>
                                    </div>
                                    
                                    <div className="bg-white rounded-3xl p-4 shadow-sm border border-gray-100 relative overflow-hidden">
                                        {leaderboard.length === 0 ? (
                                            <div className="text-center py-8 text-gray-400 text-sm">아직 랭킹 정보가 없습니다.</div>
                                        ) : (
                                            <div className="space-y-4">
                                                {leaderboard.map((user, idx) => {
                                                    let rankBadge;
                                                    if (idx === 0) {
                                                        rankBadge = <div className="w-12 h-12 flex items-center justify-center bg-gradient-to-tr from-yellow-300 via-yellow-400 to-amber-500 rounded-full shadow-[0_0_15px_rgba(250,204,21,0.6)] animate-pulse border-2 border-white"><span className="text-2xl drop-shadow-md">👑</span></div>;
                                                    } else if (idx === 1) {
                                                        rankBadge = <div className="w-10 h-10 flex items-center justify-center bg-gradient-to-tr from-gray-200 to-gray-400 rounded-full shadow-md border-2 border-white"><span className="text-xl">🥈</span></div>;
                                                    } else if (idx === 2) {
                                                        rankBadge = <div className="w-9 h-9 flex items-center justify-center bg-gradient-to-tr from-amber-600 to-amber-700 rounded-full shadow-sm border-2 border-white"><span className="text-lg">🥉</span></div>;
                                                    } else {
                                                        rankBadge = <div className="w-8 h-8 flex items-center justify-center bg-gray-100 text-gray-500 font-bold rounded-full text-sm">{idx + 1}</div>;
                                                    }
                                                    
                                                    const isMe = currentUser && user.id === currentUser.id;

                                                    return (
                                                        <div key={user.id} className={`flex items-center justify-between p-3 rounded-2xl border ${isMe ? 'bg-yellow-50 border-yellow-300 shadow-md transform scale-[1.02] z-10 relative' : 'bg-gray-50 border-gray-100 hover:bg-gray-100 transition-colors'}`}>
                                                            <div className="flex items-center gap-4">
                                                                <div className="w-12 flex justify-center items-center">{rankBadge}</div>
                                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center shadow-sm shrink-0 ${isMe ? 'bg-yellow-100' : 'bg-white'}`}>
                                                                    <div className="relative w-full h-full">
                                                                        {user.profileImage ? (
                                                                            <img src={user.profileImage} alt="profile" className="w-full h-full rounded-full object-cover border border-gray-200" />
                                                                        ) : (
                                                                            <div className="w-full h-full flex items-center justify-center">
                                                                                <Icons.User className={`w-5 h-5 ${isMe ? 'text-yellow-600' : 'text-gray-400'}`} />
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <div>
                                                                    <p className="font-bold text-gray-800 text-sm">{user.name} {isMe && <span className="text-[10px] text-white font-bold ml-1 bg-yellow-500 px-1.5 py-0.5 rounded-full">나</span>}</p>
                                                                    <p className="text-[10px] text-gray-500">{user.grade}</p>
                                                                </div>
                                                            </div>
                                                            <div className="flex items-center gap-1 font-bold text-gray-400 bg-white px-3 py-1.5 rounded-full shadow-sm text-[10px] border border-gray-200">
                                                                <Icons.Lock className="w-3 h-3" /> 비공개
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'shop' && (
                                <div className="animate-fadeIn space-y-6">
                                    <div className="bg-gradient-to-r from-indigo-500 to-purple-500 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden"><div className="relative z-10"><p className="text-indigo-100 text-sm mb-1">보유 달란트</p><h2 className="text-3xl font-bold flex items-center gap-2"><Icons.Star className="w-6 h-6 fill-yellow-300 text-yellow-300"/> {talents}</h2></div><Icons.ShoppingBag className="absolute right-[-20px] bottom-[-20px] w-32 h-32 opacity-10 rotate-12"/></div>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        {shopItems.map(item => (
                                            <div key={item.id} className="bg-cyan-50 rounded-xl p-4 shadow-sm border border-cyan-100 text-center flex flex-col items-center hover:shadow-md transition-shadow">
                                                <div className="w-14 h-14 bg-white rounded-full flex items-center justify-center mb-3 shadow-sm">
                                                    {renderIcon(item.iconName, item.iconColor)}
                                                </div>
                                                <span className="text-xs text-cyan-600 mb-1">{item.category}</span><h3 className="font-bold text-cyan-900 text-sm mb-2">{item.name}</h3>
                                                <button onClick={() => onClickBuy(item)} className="w-full py-2 bg-white text-cyan-700 border border-cyan-200 text-sm font-bold rounded-lg hover:bg-cyan-100 transition-colors">{item.cost.toLocaleString()} D 구매</button>
                                            </div>
                                        ))}
                                    </div>

                                    {/* 상품 신청 섹션 */}
                                    <div className="mt-6 bg-rose-50 rounded-2xl p-5 border border-rose-100 flex justify-between items-center shadow-sm">
                                        <div>
                                            <h3 className="font-bold text-rose-900 text-sm mb-1">원하는 상품이 없나요?</h3>
                                            <p className="text-[11px] text-rose-600">전도사님께 새로운 상품을 신청해보세요!</p>
                                        </div>
                                        <button onClick={() => setShowItemRequestModal(true)} className="px-4 py-2.5 bg-rose-400 text-white font-bold text-xs rounded-xl shadow-md hover:bg-rose-500 transition-colors">상품 신청</button>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'profile' && (
                                <div className="animate-fadeIn space-y-6">
                                    <div className="flex flex-col items-center py-6">
                                        <div className="relative mb-4">
                                            {/* 프로필 이미지 (클릭 시 확대는 취소, 그냥 보기만) */}
                                            <div 
                                                className="w-24 h-24 bg-gradient-to-tr from-pink-300 to-purple-300 rounded-full p-1 shadow-lg flex items-center justify-center"
                                            >
                                                <div className="w-full h-full bg-white rounded-full flex items-center justify-center overflow-hidden relative">
                                                    {currentUser?.profileImage ? (
                                                        <img src={currentUser.profileImage} alt="profile" className="w-full h-full object-cover" />
                                                    ) : (
                                                        <Icons.User className="w-12 h-12 text-gray-400"/>
                                                    )}
                                                </div>
                                            </div>

                                            {/* 업로드 버튼 (카메라 아이콘) */}
                                            <input type="file" id="profile-upload" className="hidden" onChange={handleProfileImageUpload} accept="image/*" />
                                            <label 
                                                htmlFor="profile-upload" 
                                                className="absolute bottom-0 right-0 bg-white rounded-full p-2 border shadow-md hover:bg-gray-50 transition-colors cursor-pointer active:scale-90"
                                            >
                                                <Icons.Camera className="w-4 h-4 text-gray-600" />
                                            </label>
                                        </div>
                                        <h2 className="text-xl font-bold text-gray-800">{currentUser?.name}</h2><p className="text-sm text-gray-500">{currentUser?.grade ? `예본TeenQT ${currentUser.grade}` : '예본TeenQT 회원'}</p>
                                        <button onClick={handleLogout} className="mt-2 text-xs flex items-center gap-1 text-gray-400 hover:text-red-500"><Icons.LogOut className="w-3 h-3"/> 로그아웃</button>
                                    </div>
                                    
                                    {/* 보관함 목록 분리 및 토글 기능 */}
                                    {(() => {
                                        const availableItems = purchasedItems.filter(item => !item.used);
                                        const usedItems = purchasedItems.filter(item => item.used);
                                        return (
                                            <>
                                                <div className="bg-fuchsia-50 rounded-2xl p-5 shadow-sm border border-fuchsia-100">
                                                    <div className="flex justify-between items-center mb-4">
                                                        <h3 className="font-bold text-fuchsia-900 text-sm">내 보관함</h3>
                                                        <span className="text-xs font-bold text-fuchsia-600 bg-fuchsia-100 px-2 py-1 rounded-full">사용 가능 {availableItems.length}개</span>
                                                    </div>
                                                    {availableItems.length === 0 ? <div className="text-center py-8 text-fuchsia-400/70 text-sm">보관 중인 아이템이 없습니다.</div> : 
                                                    <div className="space-y-3">{availableItems.map(item => (
                                                        <div key={item.uniqueId} className="flex items-center gap-3 p-3 rounded-xl relative overflow-hidden bg-white border border-fuchsia-200 shadow-sm">
                                                            <div className="w-10 h-10 bg-fuchsia-50 rounded-full flex items-center justify-center shadow-inner relative z-10">
                                                                {renderIcon(item.iconName, item.iconColor, "w-5 h-5")}
                                                            </div>
                                                            <div className="flex-1 relative z-10"><p className="font-bold text-sm text-gray-800">{item.name}</p><p className="text-xs text-gray-500">교환 가능</p></div>
                                                            <button onClick={() => onClickUse(item)} className="text-xs px-3 py-1.5 rounded-lg font-bold relative z-10 bg-fuchsia-100 text-fuchsia-600 hover:bg-fuchsia-200">교환하기</button>
                                                        </div>
                                                    ))}</div>}
                                                </div>

                                                {usedItems.length > 0 && (
                                                    <div className="pt-2">
                                                        <button onClick={() => setShowUsedItems(!showUsedItems)} className="w-full flex justify-center items-center gap-1 text-xs text-gray-400 font-medium hover:text-gray-600 transition-colors py-2">
                                                            {showUsedItems ? '사용 완료 내역 숨기기' : '사용 완료 내역 보기'}
                                                            {showUsedItems ? <Icons.ChevronUp className="w-3 h-3"/> : <Icons.ChevronDown className="w-3 h-3"/>}
                                                        </button>
                                                        {showUsedItems && (
                                                            <div className="mt-2 space-y-2 animate-fadeIn">
                                                                {usedItems.map(item => (
                                                                    <div key={item.uniqueId} className="flex items-center gap-3 p-3 rounded-xl relative overflow-hidden border bg-white/50 border-gray-200 opacity-60">
                                                                        <div className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center shadow-inner relative z-10">
                                                                            {renderIcon(item.iconName, "text-gray-400", "w-5 h-5")}
                                                                        </div>
                                                                        <div className="flex-1 relative z-10"><p className="font-bold text-sm text-gray-800">{item.name}</p><p className="text-[10px] text-gray-500">사용일: {item.useDate || '날짜 없음'}</p></div>
                                                                        <button disabled className="text-xs px-3 py-1.5 rounded-lg font-bold relative z-10 bg-gray-200 cursor-not-allowed text-gray-500">완료됨</button>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </>
                                        );
                                    })()}

                                    <div onClick={handleAdminAccess} className="bg-rose-50 rounded-2xl p-5 shadow-sm border border-rose-100 flex justify-between items-center cursor-pointer hover:bg-rose-100 transition-colors"><div className="flex items-center gap-3"><div className="w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-sm"><Icons.Lock className="w-4 h-4 text-rose-500"/></div><span className="font-medium text-rose-900 text-sm">관리자 모드</span></div><Icons.ChevronRight className="w-4 h-4 text-rose-400"/></div>
                                </div>
                            )}
                        </div>

                        {/* 하단 네비게이션 */}
                        <div className="w-full bg-white border-t border-gray-100 flex justify-around px-2 pb-safe pt-2 z-20 shrink-0">
                            <TabButton id="qt" icon={<Icons.BookOpen className={`w-6 h-6 ${activeTab==='qt'?"text-purple-600":"text-gray-400"}`}/>} label="QT" />
                            <TabButton id="event" icon={<Icons.PartyPopper className={`w-6 h-6 ${activeTab==='event'?"text-purple-600":"text-gray-400"}`}/>} label="이벤트" />
                            <TabButton id="ranking" icon={<Icons.Trophy className={`w-6 h-6 ${activeTab==='ranking'?"text-purple-600":"text-gray-400"}`}/>} label="랭킹" />
                            <TabButton id="shop" icon={<Icons.ShoppingBag className={`w-6 h-6 ${activeTab==='shop'?"text-purple-600":"text-gray-400"}`}/>} label="상점" />
                            <TabButton id="profile" icon={<Icons.User className={`w-6 h-6 ${activeTab==='profile'?"text-purple-600":"text-gray-400"}`}/>} label="MY" />
                        </div>
                        
                        {/* Modals */}
                        {showRewardModal && <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/20 backdrop-blur-sm animate-fadeIn"><div className="bg-white rounded-3xl p-8 text-center shadow-2xl mx-8"><Icons.Star className="w-10 h-10 text-yellow-500 mx-auto mb-4"/><h3 className="text-xl font-bold">{rewardMessage.title}</h3><p className="text-gray-500 mb-4 text-sm">{rewardMessage.desc}</p><div className="bg-yellow-50 text-yellow-700 font-bold py-2 px-4 rounded-xl">+ {rewardMessage.amount} 달란트!</div></div></div>}
                        {purchaseModalItem && <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm animate-fadeIn px-4"><div className="bg-white rounded-3xl p-6 w-full max-w-xs text-center shadow-2xl"><h3 className="font-bold text-lg mb-1 text-gray-800">{purchaseModalItem.name}</h3><p className="text-sm text-gray-500 mb-6">{purchaseModalItem.cost.toLocaleString()} 달란트로 구매하시겠습니까?</p><div className="flex gap-2"><button onClick={() => setPurchaseModalItem(null)} className="flex-1 py-3 bg-gray-100 font-bold text-gray-600 rounded-xl">취소</button><button onClick={confirmPurchase} className="flex-1 py-3 bg-purple-500 font-bold text-white rounded-xl shadow-md">구매하기</button></div></div></div>}
                        {useModalItem && <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm animate-fadeIn px-4"><div className="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl"><h3 className="font-bold text-lg mb-2 text-center text-gray-800">선생님 확인</h3><p className="text-sm mb-4 text-gray-500 text-center">선생님(관리자) 비밀번호를 입력해주세요.</p><input type="password" value={teacherPassword} onChange={e=>setTeacherPassword(e.target.value)} className="w-full border border-gray-200 bg-gray-50 p-3 rounded-xl mb-6 text-center focus:outline-none focus:ring-2 focus:ring-pink-400" placeholder="비밀번호 입력"/><div className="flex gap-2"><button onClick={() => setUseModalItem(null)} className="flex-1 py-3 bg-gray-100 font-bold text-gray-600 rounded-xl">취소</button><button onClick={confirmUse} className="flex-1 py-3 bg-pink-500 font-bold text-white rounded-xl shadow-md">확인</button></div></div></div>}
                        {showAdminLoginModal && <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm animate-fadeIn px-4"><div className="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl"><h3 className="font-bold text-lg mb-4 text-center text-gray-800">관리자 로그인</h3><input type="password" value={adminPasswordInput} onChange={e=>setAdminPasswordInput(e.target.value)} className="w-full border border-gray-200 bg-gray-50 p-3 rounded-xl mb-6 text-center focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="비밀번호 입력"/><div className="flex gap-2"><button onClick={() => setShowAdminLoginModal(false)} className="flex-1 py-3 bg-gray-100 font-bold text-gray-600 rounded-xl">취소</button><button onClick={confirmAdminLogin} className="flex-1 py-3 bg-indigo-500 font-bold text-white rounded-xl shadow-md">로그인</button></div></div></div>}
                        {showAdminModal && <AdminModal onClose={() => setShowAdminModal(false)} appId={appId} db={db} showToast={showToast} />}
                        
                        {/* 상품 신청 모달 */}
                        {showItemRequestModal && (
                            <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm animate-fadeIn px-4">
                                <div className="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl text-center">
                                    <h3 className="font-bold text-lg mb-2 text-gray-800">상품 신청하기</h3>
                                    <p className="text-xs mb-4 text-gray-500">상점에 추가되었으면 하는<br/>상품의 이름을 적어주세요.</p>
                                    <input type="text" value={requestItemName} onChange={e=>setRequestItemName(e.target.value)} className="w-full border border-gray-200 bg-gray-50 p-3 rounded-xl mb-6 text-center focus:outline-none focus:ring-2 focus:ring-rose-400 text-sm" placeholder="예: BHC 싸이버거 세트"/>
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowItemRequestModal(false)} className="flex-1 py-3 bg-gray-100 font-bold text-gray-600 rounded-xl text-sm hover:bg-gray-200 transition-colors">취소</button>
                                        <button onClick={submitItemRequest} className="flex-1 py-3 bg-rose-400 font-bold text-white rounded-xl shadow-md text-sm hover:bg-rose-500 transition-colors">신청하기</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 프로필 이미지 확대 모달 (취소됨 - 기능 제거) */}
                        {/* showProfileImageModal && ... */}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
